<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steam Key Formatter for ASF — v1.0</title>
  <style>
    :root { --bg:#000000; --card:#070b10; --muted:#9db4c8; --text:#eaf4ff; --accent:#6bb6ff; --accent-2:#2a80ff; }
    * { box-sizing: border-box; }
    html,body { height: 100%; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:#000; color:var(--text); }
    body::before{
      content:""; position:fixed; inset:-20vmax; pointer-events:none;
      background: radial-gradient(30vmax 20vmax at 85% -10%, rgba(38,119,255,.25), transparent 60%),
                  radial-gradient(22vmax 16vmax at 10% 110%, rgba(38,119,255,.18), transparent 60%);
      filter: blur(40px) saturate(120%); animation: drift 18s ease-in-out infinite alternate; z-index:-1;
    }
    @keyframes drift { from { transform: translate3d(-2%, -1%, 0) scale(1); } to { transform: translate3d(2%, 1%, 0) scale(1.03); } }

    .wrap { max-width: 980px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 1.6rem; margin: 0 0 10px; letter-spacing: .3px; }
    .version { font-size:.9rem; color:var(--muted); margin-left:.4rem }

    .card { background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
            border: 1px solid rgba(255,255,255,.06); border-radius: 18px;
            box-shadow: 0 10px 40px rgba(0,0,0,.6), 0 0 0 1px rgba(107,182,255,.04) inset;
            overflow: hidden; backdrop-filter: blur(6px); animation: popin .6s ease-out; }
    @keyframes popin { from { transform: translateY(8px) scale(.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

    .row { display:grid; grid-template-columns: 1fr; gap:14px; padding:16px; }
    @media (min-width: 900px){ .row { grid-template-columns: 1fr 1fr; } }

    textarea, pre { width:100%; min-height:240px; height:auto; padding:14px 16px; resize:none;
      font:12.5px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
      border:1px solid rgba(255,255,255,.06); border-radius:14px; background:#03060b; color:var(--text);
      outline:none; transition:border-color .25s ease, box-shadow .25s ease, transform .1s ease; }
    textarea:focus { border-color:rgba(107,182,255,.65); box-shadow:0 0 0 3px rgba(42,128,255,.25), 0 10px 30px rgba(0,0,0,.45); transform:translateY(-1px); }
    pre { white-space:pre-wrap; word-break:break-word; position:relative; }
    pre::after{ content:""; position:absolute; inset:0; pointer-events:none;
      background:linear-gradient(90deg, rgba(42,128,255,.06), transparent 20%, transparent 80%, rgba(42,128,255,.06));
      opacity:0; transition:opacity .6s ease; }
    .highlight pre::after{ opacity:1; animation:shimmer 1.2s ease; }
    @keyframes shimmer { from{ background-position:-100% 0; } to{ background-position:200% 0; } }

    .controls { display:flex; flex-wrap:wrap; gap:8px 14px; align-items:center; padding:12px 16px;
      border-top:1px solid rgba(255,255,255,.06); background: rgba(12,18,26,.6); }

    .btn { position:relative; padding:10px 14px; border-radius:12px; border:1px solid rgba(107,182,255,.35);
      background:linear-gradient(180deg, rgba(42,128,255,.25), rgba(42,128,255,.15)); color:var(--text);
      cursor:pointer; font-weight:700; letter-spacing:.2px; transition: transform .12s ease, box-shadow .25s ease, filter .25s ease; }
    .btn::before{ content:""; position:absolute; inset:-2px; border-radius:14px;
      background:radial-gradient(60% 60% at 50% -20%, rgba(107,182,255,.6), transparent 60%); filter:blur(12px);
      opacity:.45; z-index:-1; transition:opacity .25s ease; }
    .btn:hover { box-shadow:0 10px 30px rgba(42,128,255,.25); transform:translateY(-1px); }
    .btn:active { transform:translateY(0); filter:brightness(.96); }

    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12); background:rgba(12,18,26,.9); font-size:12px; color:var(--muted);
      transition:border-color .25s ease, background .25s ease; }
    .pill:hover { border-color: rgba(107,182,255,.45); background: rgba(12,18,26,1); }
    .pill input { accent-color: var(--accent); }

    .hint { color:var(--muted); font-size:12px; }
    .header { display:flex; justify-content:space-between; align-items:end; gap:16px; margin-bottom:12px; }
    .footer { margin-top:12px; color:var(--muted); font-size:12px; }
    .small { font-size:11.5px; color:var(--muted); }
    .kbd { border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); border-radius:6px; padding:2px 6px; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; }
    .sr { position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }

    .pulseGlow { box-shadow:0 0 0 0 rgba(42,128,255,.45); animation:pulse 1.8s ease-out 2; }
    @keyframes pulse { 0%{ box-shadow:0 0 0 0 rgba(42,128,255,.55);} 70%{ box-shadow:0 0 0 18px rgba(42,128,255,0);} 100%{ box-shadow:0 0 0 0 rgba(42,128,255,0);} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Steam Key Formatter for ASF <span class="version">v1.0</span> → <span class="small">Steam style</span></h1>
        <div class="hint">Paste Humble or Fanatical text on the left. The right side outputs <code>KEY | Title</code>. All local (no uploads).</div>
      </div>
      <button id="exampleBtn" class="btn" title="Load example">Load example</button>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label class="sr" for="input">Input</label>
          <textarea id="input" placeholder="Paste keys block here…"></textarea>
        </div>
        <div>
          <label class="sr" for="output">Output</label>
          <pre id="output" aria-live="polite"></pre>
        </div>
      </div>
      <div class="controls">
        <button id="copyBtn" class="btn">Copy output</button>
        <button id="downloadBtn" class="btn">Download .txt</button>
        <button id="processBtn" class="btn" title="Force format the current text">Process</button>
        <label class="pill"><input id="dedupe" type="checkbox" checked /> Remove duplicates</label>
        <label class="pill"><input id="sort" type="checkbox" /> Sort A→Z by title</label>
        <label class="pill"><input id="steamOnly" type="checkbox" checked /> Strict Steam key format (5-5-5)</label>
        <span class="hint">Tip: paste with <span class="kbd">Ctrl</span>+<span class="kbd">V</span>. Parsing is automatic.</span>
      </div>
    </div>

    <div class="footer">
      <div>Keys like <em>XXXXX-XXXXX-XXXXX</em> are detected. Title = nearest non-boilerplate line above the key (Fanatical noise removed).</div>
    </div>
  </div>

  <script>
    (function(){
      const elIn = document.getElementById('input');
      const elOut = document.getElementById('output');
      const elCopy = document.getElementById('copyBtn');
      const elDownload = document.getElementById('downloadBtn');
      const elProcess = document.getElementById('processBtn');
      const elDedupe = document.getElementById('dedupe');
      const elSort = document.getElementById('sort');
      const elStrict = document.getElementById('steamOnly');
      const elExample = document.getElementById('exampleBtn');
      const card = document.querySelector('.card');

      function normalizeInput(s){
        if(!s) return '';
        s = s.normalize('NFKC');
        s = s.replace(/[\u2010-\u2015\u2212\u2043]/g, '-'); // unicode dashes → '-'
        s = s.replace(/[\u200B-\u200D\uFEFF]/g, '');       // zero-width + BOM
        s = s.replace(/\u00A0/g, ' ');                    // nbsp → space
        return s;
      }

      // Boilerplate to ignore as titles (Humble + Fanatical)
      function isBoiler(s){
        if(!s) return true;
        // Humble
        if(/^redeem$/i.test(s)) return true;
        if(/steam will not provide extra giftable copies/i.test(s)) return true;
        if(/^steam key$/i.test(s)) return true;
        if(/^copy$/i.test(s)) return true;
        // Fanatical
        if(/^product cover for\b/i.test(s)) return true;          // label line
        if(/^steam logo$/i.test(s)) return true;
        if(/^how do i redeem my key\??$/i.test(s)) return true;
        if(/^open product details$/i.test(s)) return true;        // extra UI line
        if(/^view key$/i.test(s)) return true;
        if(/^reveal key$/i.test(s)) return true;
        if(/^copy key$/i.test(s)) return true;
        if(/^build your own.*bundle$/i.test(s)) return true;      // bundle headers
        return false;
      }

      function coverNameFrom(line){
        const m = /^product cover for\s*(.+)$/i.exec(line || '');
        return m ? m[1].trim() : '';
      }

      function parse(input){
        const raw = normalizeInput(input);
        if(!raw.trim()) return '';

        const strictRe = /\b([A-Z0-9]{5}-[A-Z0-9]{5}-[A-Z0-9]{5})\b/g;
        const looseRe  = /\b([A-Z0-9]{4,5}-[A-Z0-9]{4,5}-[A-Z0-9]{4,5})\b/g;
        const useStrict = elStrict.checked;
        const keyRe = useStrict ? strictRe : looseRe;

        const lines = raw.split(/\r?\n/).map(s => s.trim());

        // Find title up to N lines above key (prevents far-away grabs)
        const MAX_BACK = 6;
        function titleAbove(idx){
          let fallback = '';
          for(let j = idx - 1, steps=0; j >= 0 && steps < MAX_BACK; j--, steps++){
            const t = lines[j];
            if(!t) continue;
            if(/^product cover for\b/i.test(t) && !fallback) fallback = coverNameFrom(t);
            if(isBoiler(t)) continue;
            return t;
          }
          return fallback;
        }

        function collect(regex){
          const found = [];
          for(let i=0;i<lines.length;i++){
            const upper = lines[i].toUpperCase();
            const matches = Array.from(upper.matchAll(regex), m => m[1]);
            if(matches.length === 0) continue;
            const title = titleAbove(i);
            if(!title) continue;
            for(const k of matches) found.push({ title, key: k.toUpperCase() });
          }
          return found;
        }

        let found = collect(keyRe);
        if(found.length === 0 && useStrict) found = collect(looseRe);
        if(found.length === 0) return '';

        // Group by title
        const byTitle = new Map();
        for(const {title, key} of found){
          if(!byTitle.has(title)) byTitle.set(title, []);
          byTitle.get(title).push(key);
        }

        let rows = [];
        for(const [title, keys] of byTitle){
          if(elDedupe.checked){
            const uniq = Array.from(new Set(keys));
            const kept = uniq[0] || '';
            const count = keys.length;
            const suffix = count > 1 ? ` .${count}` : '';
            rows.push(`${kept} | ${title}${suffix}`);
          } else {
            for(const k of keys) rows.push(`${k} | ${title}`);
          }
        }

        if(elSort.checked){
          rows.sort((a,b) => {
            const at = a.split(' | ').slice(1).join(' | ').toLowerCase();
            const bt = b.split(' | ').slice(1).join(' | ').toLowerCase();
            return at.localeCompare(bt);
          });
        }
        return rows.join('\n');
      }

      function update(){
        elOut.textContent = parse(elIn.value);
        autoResize(elIn); autoResize(elOut);
        elOut.parentElement.classList.add('highlight');
        setTimeout(()=>elOut.parentElement.classList.remove('highlight'), 700);
      }

      async function copyOutput(showToast=true){
        try{ await navigator.clipboard.writeText(elOut.textContent || ''); if(showToast) toast('Copied formatted keys'); }
        catch{ if(showToast) toast('Copy failed. Select and copy manually.'); }
      }

      // events
      elIn.addEventListener('input', () => { update(); /* no auto-copy while typing */ });
      elDedupe.addEventListener('change', ()=>{ update(); copyOutput(false); });
      elSort.addEventListener('change',   ()=>{ update(); copyOutput(false); });
      elStrict.addEventListener('change', ()=>{ update(); copyOutput(false); });
      elCopy.addEventListener('click', copyOutput);
      elProcess.addEventListener('click', () => { update(); copyOutput(); pulse(elOut); });

      elDownload.addEventListener('click', () => {
        const blob = new Blob([elOut.textContent || ''], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'keys.txt';
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      });

      elExample.addEventListener('click', () => {
        elIn.value =
`Build your own Tower Defense Bundle
Product cover for Compadrone: Land Wars
Compadrone: Land Wars
steam logo
P3GBH-LKBQT-6IPPV
How Do I Redeem My Key?
Product cover for DG2: Defense Grid 2
DG2: Defense Grid 2
steam logo
GWH6X-P2PE8-VHNQA
How Do I Redeem My Key?
Product cover for Everwarder
Everwarder
steam logo
0Y4YR-3J4FJ-EEI32
How Do I Redeem My Key?

Operation Wolf Returns: First Mission
7M90A-LN00T-3W9WL
Redeem
Steam will not provide extra giftable copies of games you already own.`;
        update(); pulse(card);
      });

      // parse after paste lands, then auto-copy
      elIn.addEventListener('paste', () => setTimeout(async () => {
        update();
        const lines = (elOut.textContent || '').split(/\r?\n/).filter(Boolean);
        await copyOutput(false);
        toast(`Auto-copied ${lines.length} line${lines.length===1?'':'s'}`);
        pulse(elOut);
      }, 0));

      function autoResize(el){
        if(!el) return;
        el.style.height = 'auto';
        const max = Math.max(240, Math.min(window.innerHeight * 0.8, el.scrollHeight + 8));
        el.style.height = max + 'px';
      }
      window.addEventListener('resize', () => { autoResize(elIn); autoResize(elOut); });

      function pulse(el){ el.classList.remove('pulseGlow'); void el.offsetWidth; el.classList.add('pulseGlow'); }

      function toast(msg){
        const t = document.createElement('div');
        t.textContent = msg;
        t.style.position='fixed'; t.style.right='16px'; t.style.bottom='16px';
        t.style.padding='10px 12px'; t.style.borderRadius='12px';
        t.style.background='linear-gradient(180deg, rgba(42,128,255,.9), rgba(42,128,255,.75))';
        t.style.color='white'; t.style.fontSize='12.5px';
        t.style.border='1px solid rgba(255,255,255,.18)'; t.style.zIndex=9999;
        t.style.boxShadow='0 10px 30px rgba(42,128,255,.35)';
        t.style.transform='translateY(10px)'; t.style.opacity='0';
        t.style.transition='transform .25s ease, opacity .25s ease';
        document.body.appendChild(t);
        requestAnimationFrame(()=>{ t.style.transform='translateY(0)'; t.style.opacity='1'; });
        setTimeout(()=>{ t.style.transform='translateY(10px)'; t.style.opacity='0'; setTimeout(()=>t.remove(), 250); },1600);
      }

      update(); // initial
    })();
  </script>
</body>
</html>
