<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Humble Key Formatter</title>
  <style>
    :root { --bg:#0b0f14; --card:#121923; --muted:#9fb0c3; --text:#e6eef7; --accent:#66b2ff; }
    * { box-sizing: border-box; }
    html,body { height: 100%; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: radial-gradient(1200px 800px at 80% -100px, #16324a 0%, transparent 50%), var(--bg); color: var(--text); }
    .wrap { max-width: 980px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 1.6rem; margin: 0 0 10px; letter-spacing: .3px; }
    .card { background: var(--card); border: 1px solid rgba(255,255,255,.06); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); overflow: hidden; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
    textarea, pre { width: 100%; height: 380px; padding: 14px 16px; resize: vertical; font: 12.5px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; border: none; border-radius: 12px; background: #0e1420; color: var(--text); outline: none; }
    pre { white-space: pre-wrap; word-break: break-word; background: #0b1320; }
    .controls { display:flex; flex-wrap: wrap; gap: 8px 14px; align-items: center; padding: 12px 16px; border-top: 1px solid rgba(255,255,255,.06); background: rgba(255,255,255,.03); }
    .btn { padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,.1); background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); color: var(--text); cursor: pointer; font-weight: 600; letter-spacing: .2px; }
    .btn:hover { border-color: rgba(255,255,255,.18); box-shadow: 0 6px 16px rgba(0,0,0,.35); }
    .btn:active { transform: translateY(1px); }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03); font-size: 12px; color: var(--muted); }
    .pill input { accent-color: var(--accent); }
    .hint { color: var(--muted); font-size: 12px; }
    .header { display:flex; justify-content: space-between; align-items: end; gap: 16px; margin-bottom: 12px; }
    .footer { margin-top: 12px; color: var(--muted); font-size: 12px; }
    .small { font-size: 11.5px; color: var(--muted); }
    .kbd { border: 1px solid rgba(255,255,255,.16); background: rgba(255,255,255,.06); border-radius: 6px; padding: 2px 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .row { display: grid; grid-template-columns: 1fr; gap: 14px; padding: 16px; }
    @media (min-width: 900px){ .row { grid-template-columns: 1fr 1fr; } }
    .sr { position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Humble Key Formatter → <span class="small">Steam style</span></h1>
        <div class="hint">Paste your Humble Bundle page text on the left. The right side will output <code>KEY | Title</code> pairs. Works fully client‑side (no uploads).</div>
      </div>
      <button id="exampleBtn" class="btn" title="Load example">Load example</button>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label class="sr" for="input">Input</label>
          <textarea id="input" placeholder="Paste Humble keys block here…"></textarea>
        </div>
        <div>
          <label class="sr" for="output">Output</label>
          <pre id="output" aria-live="polite"></pre>
        </div>
      </div>
      <div class="controls">
        <button id="copyBtn" class="btn">Copy output</button>
        <button id="downloadBtn" class="btn">Download .txt</button>
        <label class="pill"><input id="dedupe" type="checkbox" checked /> Remove duplicates</label>
        <label class="pill"><input id="sort" type="checkbox" /> Sort A→Z by title</label>
        <label class="pill"><input id="steamOnly" type="checkbox" checked /> Strict Steam key format (5-5-5)</label>
        <span class="hint">Tip: paste with <span class="kbd">Ctrl</span>+<span class="kbd">V</span>. Parsing is automatic.</span>
      </div>
    </div>

    <div class="footer">
      <div>Regex covers <em>XXXXX-XXXXX-XXXXX</em> keys. Title is taken from the nearest non-empty line above the key, skipping “Redeem”/warnings.</div>
    </div>
  </div>

  <script>
    (function(){
      const elIn = document.getElementById('input');
      const elOut = document.getElementById('output');
      const elCopy = document.getElementById('copyBtn');
      const elDownload = document.getElementById('downloadBtn');
      const elDedupe = document.getElementById('dedupe');
      const elSort = document.getElementById('sort');
      const elStrict = document.getElementById('steamOnly');
      const elExample = document.getElementById('exampleBtn');

      const WARNING = 'Steam will not provide extra giftable copies of games you already own.';

      function parse(input){
        const lines = input.split(/\r?\n/).map(s => s.trim());
        const results = [];
        const keyRegexStrict = /^[A-Z0-9]{5}-[A-Z0-9]{5}-[A-Z0-9]{5}$/;
        const keyRegexLoose = /^[A-Z0-9]{4,5}-[A-Z0-9]{4,5}-[A-Z0-9]{4,5}$/; // toggleable
        const keyRegex = elStrict.checked ? keyRegexStrict : keyRegexLoose;

        for(let i=0;i<lines.length;i++){
          const line = lines[i];
          if(!line) continue;
          if(!keyRegex.test(line)) continue;
          const key = line.toUpperCase();

          // find nearest usable title above the key
          let title = '';
          for(let j=i-1; j>=0; j--){
            const t = lines[j];
            if(!t) continue; // skip empty
            if(/^redeem$/i.test(t)) continue; // skip Redeem buttons
            if(t === WARNING) continue; // skip standard warning
            // also skip other known boilerplate lines, if any appear
            if(/^steam key$/i.test(t)) continue;
            title = t; break;
          }
          if(title){ results.push({ title, key }); }
        }

        // post-process: dedupe and sort
        let pairs = results.map(r => `${r.key} | ${r.title}`);
        if(elDedupe.checked){
          const seen = new Set();
          pairs = pairs.filter(line => (seen.has(line) ? false : (seen.add(line), true)));
        }
        if(elSort.checked){
          pairs.sort((a,b) => {
            const at = a.split(' | ').slice(1).join(' | ').toLowerCase();
            const bt = b.split(' | ').slice(1).join(' | ').toLowerCase();
            return at.localeCompare(bt);
          });
        }
        return pairs.join('\n');
      }

      function update(){
        elOut.textContent = parse(elIn.value);
      }

      elIn.addEventListener('input', update);
      elDedupe.addEventListener('change', update);
      elSort.addEventListener('change', update);
      elStrict.addEventListener('change', update);

      elCopy.addEventListener('click', async () => {
        try{
          await navigator.clipboard.writeText(elOut.textContent || '');
          toast('Copied to clipboard');
        }catch{
          toast('Copy failed. Select and copy manually.');
        }
      });

      elDownload.addEventListener('click', () => {
        const blob = new Blob([elOut.textContent || ''], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'keys.txt';
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      });

      elExample.addEventListener('click', () => {
        elIn.value = `Operation Wolf Returns: First Mission\n7M90A-LN00T-3W9WL\nRedeem\nSteam will not provide extra giftable copies of games you already own.\n\nAsterix & Obelix Slap them All! 2\n8FGY6-R2XBT-QZX20\nRedeem\nSteam will not provide extra giftable copies of games you already own.\n\nGrand Mountain Adventure: Wonderlands\n959PG-RA0RI-NRZYM\nRedeem\nSteam will not provide extra giftable copies of games you already own.`;
        update();
      });

      // tiny toast
      function toast(msg){
        const t = document.createElement('div');
        t.textContent = msg;
        t.style.position='fixed'; t.style.right='16px'; t.style.bottom='16px';
        t.style.padding='10px 12px'; t.style.borderRadius='10px';
        t.style.background='rgba(0,0,0,.8)'; t.style.color='white'; t.style.fontSize='12.5px';
        t.style.border='1px solid rgba(255,255,255,.12)'; t.style.zIndex=9999;
        document.body.appendChild(t);
        setTimeout(()=>t.remove(),1600);
      }

      // Auto-parse on paste for convenience
      elIn.addEventListener('paste', () => setTimeout(update, 0));

      // initial
      update();
    })();
  </script>
</body>
</html>
